package it.ministerodellasalute.immuni.ui.greencertificate.tabadapter

import android.annotation.SuppressLint
import android.graphics.Bitmap
import android.graphics.Color
import android.os.Bundle
import android.view.View
import androidx.fragment.app.Fragment
import com.google.zxing.BarcodeFormat
import com.google.zxing.qrcode.QRCodeWriter
import it.ministerodellasalute.immuni.R
import it.ministerodellasalute.immuni.extensions.utils.ScreenUtils
import it.ministerodellasalute.immuni.logic.user.models.GreenCertificate
import kotlinx.android.synthetic.main.green_certificate_expired.*

class TabExpired : Fragment(R.layout.green_certificate_expired), TabExpiredClickListener {

    lateinit var adapter: TabExpiredAdapter

    val listItem: List<GreenCertificate> = listOf(
        GreenCertificate(
            "06 Maggio 2021",
            "NCFOXN%TS3DH3ZSUZK+.V0ETD%65NL-AH%TAIOOW%IN5H8B48WAS*PX*GKD93B4:ZH6I1\$4JN:IN1MKK9+OC*PP:+P*.1D9R+Q6646C%6RF6:X93O5RF6\$T61R6B46646VY9WC5ME65H1KD34LT HBSZ4GH0B69X5Q/36MZ5BTMUW5-5QNF6O M9R1RF6ECM676746C0FFS6NWE0Y6Z EJZ6KS6YQEE%61Y6LMEA46B 17PPDFPVX1R270:6NEQ0R6AOM6PPL4Q0RUS-EBHU68E1W5XC52T9UF5LDCPF5RBQ746B46O1N646BQ99Q9E\$B ZJY1B QTOD3CQSP\$SR\$S3NDC9UOD3Y.TJET9G3DZI65BDM14NJ*XI-XIFRLL:F*ZR.OVOIF/HLTNP8EFNC3P:HDD8B1MM1M9NTNC30GH.Z8VHL+KLF%CD 810H% 0R%0ZD5CC9T0H\$/I*44SA3ZX8MWB8XU%7AAVMXQQYUGS6S97T95GW38TW959EGNSMJQ115QTBD MD6U725O2DZ2QQ.961GIMC3DUUKUC5QU8N4D40I5:SIK1O606I:VD30O7KK0"
        ),
        GreenCertificate(
            "06 Aprile 2021",
            "NCFOXN%TS3DH3ZSUZK+.V0ETD%65NL-AH%TAIOOW%IN5H8B48WAS*PX*GKD93B4:ZH6I1\$4JN:IN1MKK9+OC*PP:+P*.1D9R+Q6646C%6RF6:X93O5RF6\$T61R6B46646VY9WC5ME65H1KD34LT HBSZ4GH0B69X5Q/36MZ5BTMUW5-5QNF6O M9R1RF6ECM676746C0FFS6NWE0Y6Z EJZ6KS6YQEE%61Y6LMEA46B 17PPDFPVX1R270:6NEQ0R6AOM6PPL4Q0RUS-EBHU68E1W5XC52T9UF5LDCPF5RBQ746B46O1N646BQ99Q9E\$B ZJY1B QTOD3CQSP\$SR\$S3NDC9UOD3Y.TJET9G3DZI65BDM14NJ*XI-XIFRLL:F*ZR.OVOIF/HLTNP8EFNC3P:HDD8B1MM1M9NTNC30GH.Z8VHL+KLF%CD 810H% 0R%0ZD5CC9T0H\$/I*44SA3ZX8MWB8XU%7AAVMXQQYUGS6S97T95GW38TW959EGNSMJQ115QTBD MD6U725O2DZ2QQ.961GIMC3DUUKUC5QU8N4D40I5:SIK1O606I:VD30O7KK0"
        ),
        GreenCertificate(
            "06 Marzo 2021",
            "NCFOXN%TS3DH3ZSUZK+.V0ETD%65NL-AH%TAIOOW%IN5H8B48WAS*PX*GKD93B4:ZH6I1\$4JN:IN1MKK9+OC*PP:+P*.1D9R+Q6646C%6RF6:X93O5RF6\$T61R6B46646VY9WC5ME65H1KD34LT HBSZ4GH0B69X5Q/36MZ5BTMUW5-5QNF6O M9R1RF6ECM676746C0FFS6NWE0Y6Z EJZ6KS6YQEE%61Y6LMEA46B 17PPDFPVX1R270:6NEQ0R6AOM6PPL4Q0RUS-EBHU68E1W5XC52T9UF5LDCPF5RBQ746B46O1N646BQ99Q9E\$B ZJY1B QTOD3CQSP\$SR\$S3NDC9UOD3Y.TJET9G3DZI65BDM14NJ*XI-XIFRLL:F*ZR.OVOIF/HLTNP8EFNC3P:HDD8B1MM1M9NTNC30GH.Z8VHL+KLF%CD 810H% 0R%0ZD5CC9T0H\$/I*44SA3ZX8MWB8XU%7AAVMXQQYUGS6S97T95GW38TW959EGNSMJQ115QTBD MD6U725O2DZ2QQ.961GIMC3DUUKUC5QU8N4D40I5:SIK1O606I:VD30O7KK0"
        ),
        GreenCertificate(
            "06 Febbraio 2021",
            "NCFOXN%TS3DH3ZSUZK+.V0ETD%65NL-AH%TAIOOW%IN5H8B48WAS*PX*GKD93B4:ZH6I1\$4JN:IN1MKK9+OC*PP:+P*.1D9R+Q6646C%6RF6:X93O5RF6\$T61R6B46646VY9WC5ME65H1KD34LT HBSZ4GH0B69X5Q/36MZ5BTMUW5-5QNF6O M9R1RF6ECM676746C0FFS6NWE0Y6Z EJZ6KS6YQEE%61Y6LMEA46B 17PPDFPVX1R270:6NEQ0R6AOM6PPL4Q0RUS-EBHU68E1W5XC52T9UF5LDCPF5RBQ746B46O1N646BQ99Q9E\$B ZJY1B QTOD3CQSP\$SR\$S3NDC9UOD3Y.TJET9G3DZI65BDM14NJ*XI-XIFRLL:F*ZR.OVOIF/HLTNP8EFNC3P:HDD8B1MM1M9NTNC30GH.Z8VHL+KLF%CD 810H% 0R%0ZD5CC9T0H\$/I*44SA3ZX8MWB8XU%7AAVMXQQYUGS6S97T95GW38TW959EGNSMJQ115QTBD MD6U725O2DZ2QQ.961GIMC3DUUKUC5QU8N4D40I5:SIK1O606I:VD30O7KK0"
        ),
        GreenCertificate(
            "06 Gennaio 2021",
            "NCFOXN%TS3DH3ZSUZK+.V0ETD%65NL-AH%TAIOOW%IN5H8B48WAS*PX*GKD93B4:ZH6I1\$4JN:IN1MKK9+OC*PP:+P*.1D9R+Q6646C%6RF6:X93O5RF6\$T61R6B46646VY9WC5ME65H1KD34LT HBSZ4GH0B69X5Q/36MZ5BTMUW5-5QNF6O M9R1RF6ECM676746C0FFS6NWE0Y6Z EJZ6KS6YQEE%61Y6LMEA46B 17PPDFPVX1R270:6NEQ0R6AOM6PPL4Q0RUS-EBHU68E1W5XC52T9UF5LDCPF5RBQ746B46O1N646BQ99Q9E\$B ZJY1B QTOD3CQSP\$SR\$S3NDC9UOD3Y.TJET9G3DZI65BDM14NJ*XI-XIFRLL:F*ZR.OVOIF/HLTNP8EFNC3P:HDD8B1MM1M9NTNC30GH.Z8VHL+KLF%CD 810H% 0R%0ZD5CC9T0H\$/I*44SA3ZX8MWB8XU%7AAVMXQQYUGS6S97T95GW38TW959EGNSMJQ115QTBD MD6U725O2DZ2QQ.961GIMC3DUUKUC5QU8N4D40I5:SIK1O606I:VD30O7KK0"
        )
    )

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        adapter = TabExpiredAdapter(this)
        recyclerView.adapter = adapter
        adapter.data = listItem

        backToList.setOnClickListener {
            layoutQrCode.visibility = View.GONE
            recyclerView.visibility = View.VISIBLE
        }
    }

    @SuppressLint("SetTextI18n")
    override fun onClick(item: GreenCertificate) {
        layoutQrCode.visibility = View.VISIBLE
        recyclerView.visibility = View.GONE
        qrCode.setImageBitmap(createQRCode(item))
        expiredText.text = getString(R.string.green_pass_expired_text) + item.expiredDate
    }

    private fun createQRCode(item: GreenCertificate): Bitmap? {
        val writer = QRCodeWriter()
        val bitMatrix = writer.encode(
            item.base45, BarcodeFormat.QR_CODE,
            ScreenUtils.convertPixelsToDp(requireContext(), 400F).toInt(),
            ScreenUtils.convertPixelsToDp(requireContext(), 400F).toInt()
        )
        val width = bitMatrix.width
        val height = bitMatrix.height
        val bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.RGB_565)
        for (x in 0 until width) {
            for (y in 0 until height) {
                bitmap.setPixel(x, y, if (bitMatrix.get(x, y)) Color.BLACK else Color.WHITE)
            }
        }
        return bitmap
    }
}
